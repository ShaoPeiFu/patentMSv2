# ä¸“åˆ©åˆ é™¤åŠŸèƒ½ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·åœ¨ä¸“åˆ©ç®¡ç†é¡µé¢å°è¯•åˆ é™¤ä¸“åˆ©æ—¶é‡åˆ°500å†…éƒ¨æœåŠ¡å™¨é”™è¯¯ï¼š

```
DELETE http://localhost:5173/api/patents/1 500 (Internal Server Error)
```

## é—®é¢˜åˆ†æ

é€šè¿‡æ£€æŸ¥åç«¯APIä»£ç ï¼Œå‘ç°åˆ é™¤ä¸“åˆ©åŠŸèƒ½å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

### 1. ç¼ºå°‘å…³è”è¡¨çš„çº§è”åˆ é™¤ âŒ

åŸå§‹çš„åˆ é™¤ä¸“åˆ©APIåªåˆ é™¤äº†éƒ¨åˆ†å…³è”è¡¨ï¼š
- âœ… `PatentDocument` - ä¸“åˆ©æ–‡æ¡£
- âœ… `Fee` - è´¹ç”¨è®°å½•  
- âœ… `Deadline` - æœŸé™è®°å½•
- âœ… `PatentCitation` - ä¸“åˆ©å¼•ç”¨å…³ç³»

ä½†ç¼ºå°‘äº†ä»¥ä¸‹å…³è”è¡¨çš„åˆ é™¤ï¼š
- âŒ `SmartReminder` - æ™ºèƒ½æé†’
- âŒ `CalendarEvent` - æ—¥å†äº‹ä»¶
- âŒ `RiskAssessment` - é£é™©è¯„ä¼°
- âŒ `PatentEvaluation` - ä¸“åˆ©è¯„ä¼°

### 2. ä¸“åˆ©åˆ›å»ºAPIçš„é™„å¸¦é—®é¢˜ âŒ

åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­è¿˜å‘ç°äº†ä¸“åˆ©åˆ›å»ºAPIçš„é—®é¢˜ï¼š
- å°è¯•è®¾ç½®ä¸å­˜åœ¨çš„ `documents` å­—æ®µ
- ç¼ºå°‘è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤åˆ é™¤ä¸“åˆ©API

åœ¨ `server/index.ts` çš„åˆ é™¤ä¸“åˆ©äº‹åŠ¡ä¸­æ·»åŠ ç¼ºå°‘çš„å…³è”è¡¨åˆ é™¤ï¼š

```typescript
// ä½¿ç”¨äº‹åŠ¡åˆ é™¤ä¸“åˆ©åŠå…¶æ‰€æœ‰å…³è”æ•°æ®
await prisma.$transaction(async (tx) => {
  // å…ˆåˆ é™¤æ‰€æœ‰å…³è”è®°å½•
  await tx.patentDocument.deleteMany({ where: { patentId } });
  await tx.fee.deleteMany({ where: { patentId } });
  await tx.deadline.deleteMany({ where: { patentId } });
  
  // æ–°å¢ï¼šåˆ é™¤é—æ¼çš„å…³è”è¡¨
  await tx.smartReminder.deleteMany({ where: { patentId } });
  await tx.calendarEvent.deleteMany({ where: { patentId } });
  await tx.riskAssessment.deleteMany({ where: { patentId } });
  await tx.patentEvaluation.deleteMany({ where: { patentId } });
  
  await tx.patentCitation.deleteMany({
    where: {
      OR: [{ citingPatentId: patentId }, { citedPatentId: patentId }],
    },
  });

  // æœ€ååˆ é™¤ä¸“åˆ©
  await tx.patent.delete({ where: { id: patentId } });
});
```

### 2. ä¿®å¤ä¸“åˆ©åˆ›å»ºAPI

```typescript
const patentData = {
  ...req.body,
  userId: req.user.id,
  applicationDate: new Date(req.body.applicationDate),
  keywords: req.body.keywords ? JSON.stringify(req.body.keywords) : null,
  applicants: req.body.applicants ? JSON.stringify(req.body.applicants) : null,
  inventors: req.body.inventors ? JSON.stringify(req.body.inventors) : null,
  drawings: req.body.drawings ? JSON.stringify(req.body.drawings) : null,
};

// ç§»é™¤ä¸å­˜åœ¨çš„å­—æ®µ
delete patentData.documents;
```

### 3. æ”¹è¿›é”™è¯¯å¤„ç†

æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯æ—¥å¿—ï¼š

```typescript
} catch (error) {
  console.error("åˆ›å»ºä¸“åˆ©å¤±è´¥:", error);
  res.status(500).json({ 
    error: "åˆ›å»ºä¸“åˆ©å¤±è´¥", 
    details: error.message,
    code: error.code
  });
}
```

## æµ‹è¯•éªŒè¯

åˆ›å»ºäº†å®Œæ•´çš„æµ‹è¯•è„šæœ¬éªŒè¯ä¿®å¤æ•ˆæœï¼š

```bash
ğŸš€ å¼€å§‹æµ‹è¯•ä¸“åˆ©åˆ é™¤åŠŸèƒ½...

1. æ³¨å†Œæµ‹è¯•ç”¨æˆ·...
â„¹ï¸ ç”¨æˆ·å·²å­˜åœ¨ï¼Œç»§ç»­æµ‹è¯•

2. æµ‹è¯•ç™»å½•...
âœ… ç™»å½•æˆåŠŸï¼Œè·å–åˆ°token

3. åˆ›å»ºæµ‹è¯•ä¸“åˆ©...
âœ… æµ‹è¯•ä¸“åˆ©åˆ›å»ºæˆåŠŸ
   ä¸“åˆ©ID: 4
   ä¸“åˆ©å·: TEST1755573068983

4. åˆ›å»ºå…³è”æ•°æ®...
âš ï¸ åˆ›å»ºå…³è”æ•°æ®å¤±è´¥ï¼ˆä¸å½±å“åˆ é™¤æµ‹è¯•ï¼‰

5. åˆ é™¤æµ‹è¯•ä¸“åˆ©...
âœ… ä¸“åˆ©åˆ é™¤æˆåŠŸ
   å“åº”: { success: true, message: 'ä¸“åˆ©åˆ é™¤æˆåŠŸ' }

6. éªŒè¯ä¸“åˆ©æ˜¯å¦å·²åˆ é™¤...
âœ… éªŒè¯æˆåŠŸï¼šä¸“åˆ©å·²è¢«åˆ é™¤

ğŸ‰ ä¸“åˆ©åˆ é™¤åŠŸèƒ½æµ‹è¯•å®Œæˆï¼
```

## æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“å…³ç³»åˆ†æ

ä¸“åˆ©ï¼ˆPatentï¼‰æ¨¡å‹ä¸ä»¥ä¸‹è¡¨å­˜åœ¨å…³è”å…³ç³»ï¼š
- `PatentDocument` (patentId)
- `Fee` (patentId) 
- `Deadline` (patentId)
- `SmartReminder` (patentId)
- `CalendarEvent` (patentId)
- `RiskAssessment` (patentId)
- `PatentEvaluation` (patentId)
- `PatentCitation` (citingPatentId, citedPatentId)

åˆ é™¤ä¸“åˆ©æ—¶å¿…é¡»å…ˆåˆ é™¤æ‰€æœ‰å…³è”è®°å½•ï¼Œå¦åˆ™ä¼šè¿åå¤–é”®çº¦æŸå¯¼è‡´500é”™è¯¯ã€‚

### äº‹åŠ¡å¤„ç†

ä½¿ç”¨Prismaäº‹åŠ¡ç¡®ä¿åˆ é™¤æ“ä½œçš„åŸå­æ€§ï¼š
- å¦‚æœä»»ä½•ä¸€ä¸ªåˆ é™¤æ“ä½œå¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡å›æ»š
- é¿å…æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µ
- ä¿è¯æ•°æ®åº“å®Œæ•´æ€§

### é”™è¯¯å¤„ç†æ”¹è¿›

- æ·»åŠ è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
- è¿”å›é”™è¯¯è¯¦æƒ…ç»™å‰ç«¯
- ä¾¿äºé—®é¢˜è¯Šæ–­å’Œè°ƒè¯•

## ä¿®å¤ç»“æœ

âœ… **ä¸“åˆ©åˆ é™¤åŠŸèƒ½å®Œå…¨ä¿®å¤**ï¼š
- æ‰€æœ‰å…³è”è¡¨éƒ½æ­£ç¡®åˆ é™¤
- äº‹åŠ¡å¤„ç†ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- é”™è¯¯å¤„ç†æ›´åŠ å®Œå–„
- é€šè¿‡å®Œæ•´æµ‹è¯•éªŒè¯

âœ… **ä¸“åˆ©åˆ›å»ºåŠŸèƒ½é™„å¸¦ä¿®å¤**ï¼š
- ç§»é™¤ä¸å­˜åœ¨çš„å­—æ®µ
- æ”¹è¿›é”™è¯¯æ—¥å¿—
- æé«˜APIç¨³å®šæ€§

## å½±å“èŒƒå›´

æ­¤æ¬¡ä¿®å¤å½±å“ä»¥ä¸‹åŠŸèƒ½ï¼š
1. **ä¸“åˆ©åˆ é™¤** - ä¸»è¦ä¿®å¤ç›®æ ‡
2. **æ•°æ®å®Œæ•´æ€§** - ç¡®ä¿å…³è”æ•°æ®æ­£ç¡®æ¸…ç†
3. **ç³»ç»Ÿç¨³å®šæ€§** - é¿å…500é”™è¯¯
4. **é”™è¯¯è¯Šæ–­** - æ›´å¥½çš„é”™è¯¯ä¿¡æ¯

## åç»­å»ºè®®

1. **å®šæœŸæ£€æŸ¥** - å®šæœŸæ£€æŸ¥å…¶ä»–æ¨¡å‹çš„åˆ é™¤APIæ˜¯å¦æœ‰ç±»ä¼¼é—®é¢˜
2. **æµ‹è¯•è¦†ç›–** - ä¸ºå…³é”®çš„åˆ é™¤æ“ä½œæ·»åŠ è‡ªåŠ¨åŒ–æµ‹è¯•
3. **æ–‡æ¡£æ›´æ–°** - æ›´æ–°APIæ–‡æ¡£è¯´æ˜åˆ é™¤è¡Œä¸º
4. **ç›‘æ§å‘Šè­¦** - æ·»åŠ 500é”™è¯¯çš„ç›‘æ§å‘Šè­¦

## æ€»ç»“

é€šè¿‡ç³»ç»Ÿåˆ†æPrisma schemaå’ŒAPIå®ç°ï¼ŒæˆåŠŸè¯†åˆ«å¹¶ä¿®å¤äº†ä¸“åˆ©åˆ é™¤åŠŸèƒ½çš„æ ¹æœ¬é—®é¢˜ã€‚ä¿®å¤åçš„åŠŸèƒ½ç»è¿‡å®Œæ•´æµ‹è¯•éªŒè¯ï¼Œç°åœ¨å¯ä»¥æ­£å¸¸åˆ é™¤ä¸“åˆ©åŠå…¶æ‰€æœ‰å…³è”æ•°æ®ï¼Œä¿è¯äº†æ•°æ®åº“çš„å®Œæ•´æ€§å’Œç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚
