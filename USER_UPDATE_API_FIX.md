# ç”¨æˆ·æ›´æ–° API ä¿®å¤

## é—®é¢˜æè¿°

ç”¨æˆ·å°è¯•ç¼–è¾‘ä¸ªäººä¿¡æ¯æ—¶é‡åˆ°ä»¥ä¸‹é”™è¯¯ï¼š

```
æ›´æ–°ç”¨æˆ·ä¿¡æ¯å¤±è´¥: PrismaClientKnownRequestError:
Invalid `prisma.user.update()` invocation
Unique constraint failed on the fields: (`email`)
```

## é—®é¢˜åŸå› 

1. **é‚®ç®±å”¯ä¸€æ€§çº¦æŸå†²çª**ï¼šæ•°æ®åº“ä¸­ `email` å­—æ®µè®¾ç½®äº†å”¯ä¸€çº¦æŸ (`@unique`)
2. **ç¼ºå°‘é‡å¤æ£€æŸ¥**ï¼šAPI æ²¡æœ‰åœ¨æ›´æ–°å‰æ£€æŸ¥æ–°é‚®ç®±æ˜¯å¦å·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨
3. **é‡å¤è·¯ç”±å†²çª**ï¼šä¸»æœåŠ¡å™¨æ–‡ä»¶å’Œç”¨æˆ·è·¯ç”±æ–‡ä»¶éƒ½æœ‰ç”¨æˆ·æ›´æ–°è·¯ç”±ï¼Œé€ æˆå†²çª
4. **é”™è¯¯å¤„ç†ä¸å®Œå–„**ï¼šæ²¡æœ‰é’ˆå¯¹ Prisma é”™è¯¯çš„ä¸“é—¨å¤„ç†

## è§£å†³æ–¹æ¡ˆ

### 1. ä¿®å¤ç”¨æˆ·è·¯ç”±æ–‡ä»¶ (`server/routes/users.ts`)

#### æ·»åŠ é‚®ç®±é‡å¤æ£€æŸ¥

```javascript
// æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨
if (email) {
  const existingUser = await prisma.user.findFirst({
    where: {
      email: email,
      id: { not: userId }, // æ’é™¤å½“å‰ç”¨æˆ·
    },
  });

  if (existingUser) {
    return res.status(400).json({
      error: "è¯¥é‚®ç®±åœ°å€å·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨",
      existingUser: {
        id: existingUser.id,
        username: existingUser.username,
      },
    });
  }
}
```

#### æ·»åŠ æ•°æ®éªŒè¯

```javascript
// éªŒè¯å¿…å¡«å­—æ®µ
if (!realName || !email || !phone || !department) {
  return res.status(400).json({
    error: "æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¿…å¡«çš„",
    missing: {
      realName: !realName,
      email: !email,
      phone: !phone,
      department: !department,
    },
  });
}

// éªŒè¯é‚®ç®±æ ¼å¼
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
if (!emailRegex.test(email)) {
  return res.status(400).json({ error: "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®" });
}

// éªŒè¯æ‰‹æœºå·æ ¼å¼
const phoneRegex = /^1[3-9]\d{9}$/;
if (!phoneRegex.test(phone)) {
  return res.status(400).json({ error: "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®" });
}
```

#### æ”¹è¿›é”™è¯¯å¤„ç†

```javascript
// å¤„ç†Prismaé”™è¯¯
if (error.code === "P2002") {
  const field = error.meta?.target?.[0];
  if (field === "email") {
    return res.status(400).json({
      error: "è¯¥é‚®ç®±åœ°å€å·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨",
      field: "email",
    });
  } else if (field === "username") {
    return res.status(400).json({
      error: "è¯¥ç”¨æˆ·åå·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨",
      field: "username",
    });
  }
}
```

#### æ•°æ®æ¸…ç†

```javascript
data: {
  realName: realName.trim(),
  email: email.trim().toLowerCase(),
  phone: phone.trim(),
  department: department.trim(),
  updatedAt: new Date(),
}
```

### 2. åˆ é™¤é‡å¤è·¯ç”±

ä»ä¸»æœåŠ¡å™¨æ–‡ä»¶ (`server/index.ts`) ä¸­åˆ é™¤äº†é‡å¤çš„ç”¨æˆ·æ›´æ–°è·¯ç”±ï¼Œé¿å…å†²çªã€‚

### 3. ç»Ÿä¸€è·¯ç”±ç®¡ç†

æ‰€æœ‰ç”¨æˆ·ç›¸å…³çš„ API ç°åœ¨éƒ½é€šè¿‡ `server/routes/users.ts` ç»Ÿä¸€ç®¡ç†ã€‚

## ä¿®å¤åçš„åŠŸèƒ½ç‰¹æ€§

### âœ… æ•°æ®éªŒè¯

- **å¿…å¡«å­—æ®µæ£€æŸ¥**ï¼šç¡®ä¿æ‰€æœ‰å¿…è¦å­—æ®µéƒ½æœ‰å€¼
- **é‚®ç®±æ ¼å¼éªŒè¯**ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼éªŒè¯é‚®ç®±æ ¼å¼
- **æ‰‹æœºå·æ ¼å¼éªŒè¯**ï¼šéªŒè¯ä¸­å›½æ‰‹æœºå·æ ¼å¼
- **æ•°æ®æ¸…ç†**ï¼šè‡ªåŠ¨å»é™¤é¦–å°¾ç©ºæ ¼ï¼Œé‚®ç®±è½¬å°å†™

### âœ… é‡å¤æ€§æ£€æŸ¥

- **é‚®ç®±å”¯ä¸€æ€§**ï¼šæ›´æ–°å‰æ£€æŸ¥é‚®ç®±æ˜¯å¦è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨
- **æ™ºèƒ½æ’é™¤**ï¼šæ£€æŸ¥æ—¶æ’é™¤å½“å‰ç”¨æˆ·ï¼Œå…è®¸ç”¨æˆ·ä¿æŒåŸé‚®ç®±

### âœ… é”™è¯¯å¤„ç†

- **Prisma é”™è¯¯å¤„ç†**ï¼šä¸“é—¨å¤„ç†æ•°æ®åº“çº¦æŸé”™è¯¯
- **å‹å¥½é”™è¯¯æ¶ˆæ¯**ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯è¯´æ˜
- **å­—æ®µæ ‡è¯†**ï¼šæ˜ç¡®æŒ‡å‡ºå“ªä¸ªå­—æ®µå‡ºç°é—®é¢˜

### âœ… å®‰å…¨æ€§

- **JWT è®¤è¯**ï¼šæ‰€æœ‰ API éƒ½éœ€è¦æœ‰æ•ˆä»¤ç‰Œ
- **æƒé™æ§åˆ¶**ï¼šç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„ä¿¡æ¯
- **æ•°æ®è¿‡æ»¤**ï¼šé˜²æ­¢æ¶æ„æ•°æ®æ³¨å…¥

## API å“åº”ç¤ºä¾‹

### æˆåŠŸå“åº”

```json
{
  "message": "ç”¨æˆ·ä¿¡æ¯æ›´æ–°æˆåŠŸ",
  "user": {
    "id": 2,
    "username": "shaopei",
    "realName": "æµ‹è¯•ç”¨æˆ·",
    "email": "test@example.com",
    "phone": "13800138000",
    "department": "tech",
    "role": "admin",
    "createdAt": "2025-08-18T06:01:10.000Z",
    "updatedAt": "2025-08-20T03:45:00.000Z"
  }
}
```

### é‚®ç®±é‡å¤é”™è¯¯

```json
{
  "error": "è¯¥é‚®ç®±åœ°å€å·²è¢«å…¶ä»–ç”¨æˆ·ä½¿ç”¨",
  "existingUser": {
    "id": 9,
    "username": "user1"
  }
}
```

### æ ¼å¼é”™è¯¯

```json
{
  "error": "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"
}
```

### å¿…å¡«å­—æ®µé”™è¯¯

```json
{
  "error": "æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¿…å¡«çš„",
  "missing": {
    "realName": false,
    "email": true,
    "phone": true,
    "department": false
  }
}
```

## æµ‹è¯•éªŒè¯

### ç¼–è¯‘æ£€æŸ¥

- âœ… ç”¨æˆ·è·¯ç”±æ–‡ä»¶æ— ç¼–è¯‘é”™è¯¯
- âœ… ä¸»æœåŠ¡å™¨æ–‡ä»¶æ— ç¼–è¯‘é”™è¯¯
- âœ… è·¯ç”±æ³¨å†Œæ­£å¸¸

### åŠŸèƒ½éªŒè¯

- âœ… é‚®ç®±é‡å¤æ£€æŸ¥æ­£å¸¸å·¥ä½œ
- âœ… æ•°æ®æ ¼å¼éªŒè¯æ­£å¸¸
- âœ… å¿…å¡«å­—æ®µéªŒè¯æ­£å¸¸
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… è®¤è¯æœºåˆ¶æ­£å¸¸

## ä½¿ç”¨è¯´æ˜

### å‰ç«¯è°ƒç”¨ç¤ºä¾‹

```javascript
const response = await fetch(`/api/users/${userId}`, {
  method: "PUT",
  headers: {
    "Content-Type": "application/json",
    Authorization: `Bearer ${token}`,
  },
  body: JSON.stringify({
    realName: "æ–°å§“å",
    email: "newemail@example.com",
    phone: "13800138000",
    department: "tech",
  }),
});

if (response.ok) {
  const result = await response.json();
  console.log("æ›´æ–°æˆåŠŸ:", result);
} else {
  const error = await response.json();
  console.error("æ›´æ–°å¤±è´¥:", error.error);
}
```

### æ³¨æ„äº‹é¡¹

1. **å¿…é¡»æä¾› JWT è®¤è¯ä»¤ç‰Œ**
2. **æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¿…å¡«çš„**
3. **é‚®ç®±åœ°å€å¿…é¡»å”¯ä¸€**
4. **é‚®ç®±å’Œæ‰‹æœºå·æ ¼å¼å¿…é¡»æ­£ç¡®**
5. **æ•°æ®ä¼šè‡ªåŠ¨æ¸…ç†ï¼ˆå»é™¤ç©ºæ ¼ã€é‚®ç®±è½¬å°å†™ï¼‰**

## æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼Œç”¨æˆ·æ›´æ–° API ç°åœ¨å…·å¤‡äº†ï¼š

- ğŸ”’ **å®Œå–„çš„éªŒè¯æœºåˆ¶**ï¼šé˜²æ­¢æ— æ•ˆæ•°æ®æäº¤
- ğŸš« **é‡å¤æ€§æ£€æŸ¥**ï¼šé¿å…é‚®ç®±å†²çª
- ğŸ›¡ï¸ **å®‰å…¨ä¿æŠ¤**ï¼šJWT è®¤è¯å’Œæƒé™æ§åˆ¶
- ğŸ“ **å‹å¥½é”™è¯¯æç¤º**ï¼šå¸®åŠ©ç”¨æˆ·å¿«é€Ÿå®šä½é—®é¢˜
- ğŸ§¹ **æ•°æ®æ¸…ç†**ï¼šè‡ªåŠ¨å¤„ç†è¾“å…¥æ•°æ®æ ¼å¼

ç”¨æˆ·ç°åœ¨å¯ä»¥å®‰å…¨åœ°ç¼–è¾‘ä¸ªäººä¿¡æ¯ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§å¹¶æä¾›æ¸…æ™°çš„åé¦ˆã€‚
